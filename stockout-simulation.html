<!DOCTYPE html>
<html>
<head>
  <title>Stockout Simulation - China Order System</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
      background: #000;
      color: #fafafa;
      font-size: 13px;
    }
    h1 {
      color: #60a5fa;
      font-size: 24px;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #a1a1aa;
      margin-bottom: 30px;
      font-size: 14px;
    }
    button {
      background: #1e40af;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      margin-right: 10px;
      margin-bottom: 20px;
    }
    button:hover {
      background: #2563eb;
    }
    button.run-all {
      background: #15803d;
    }
    button.run-all:hover {
      background: #16a34a;
    }
    .scenario-result {
      background: #18181b;
      border: 2px solid #27272a;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .scenario-result.critical {
      border-color: #ef4444;
    }
    .scenario-result.safe {
      border-color: #22c55e;
    }
    .scenario-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #fafafa;
    }
    .summary {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      padding: 12px;
      background: rgba(255,255,255,0.02);
      border-radius: 6px;
    }
    .summary-item {
      flex: 1;
    }
    .summary-label {
      color: #71717a;
      font-size: 11px;
      margin-bottom: 4px;
    }
    .summary-value {
      font-size: 18px;
      font-weight: bold;
    }
    .stockout-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }
    .stockout-table th {
      background: #27272a;
      padding: 8px;
      text-align: left;
      color: #a1a1aa;
      font-weight: 600;
      font-size: 11px;
    }
    .stockout-table td {
      padding: 8px;
      border-bottom: 1px solid #27272a;
    }
    .stockout {
      color: #ef4444;
      font-weight: bold;
    }
    .near-stockout {
      color: #facc15;
      font-weight: bold;
    }
    .safe {
      color: #22c55e;
    }
    .timeline {
      display: grid;
      grid-template-columns: repeat(15, 1fr);
      gap: 2px;
      margin: 15px 0;
    }
    .timeline-month {
      padding: 8px 4px;
      text-align: center;
      font-size: 10px;
      background: #27272a;
      border-radius: 3px;
    }
    .timeline-month.container {
      background: #1e40af;
      font-weight: bold;
    }
    .timeline-month.stockout {
      background: #7f1d1d;
      color: #ef4444;
    }
    .timeline-month.critical {
      background: #854d0e;
      color: #facc15;
    }
    .legend {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      font-size: 11px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .legend-box {
      width: 20px;
      height: 12px;
      border-radius: 2px;
    }
    .critical { color: #ef4444; }
    .warning { color: #facc15; }
    .healthy { color: #22c55e; }
    .info { color: #60a5fa; }
  </style>
</head>
<body>
  <h1>ðŸš¨ Stockout Simulation - Real World Test</h1>
  <div class="subtitle">Simulates 14 months of sales to find when you'll run out of mattresses</div>

  <button onclick="runSimulation('A')">Test Scenario A</button>
  <button onclick="runSimulation('B')">Test Scenario B</button>
  <button onclick="runSimulation('C')">Test Scenario C</button>
  <button onclick="runSimulation('D')">Test Scenario D</button>
  <button onclick="runSimulation('E')">Test Scenario E</button>
  <button onclick="runSimulation('F')">Test Scenario F</button>
  <button class="run-all" onclick="runAllSimulations()">ðŸ”¥ Run All Tests</button>

  <div class="legend">
    <div class="legend-item"><div class="legend-box" style="background: #22c55e;"></div> Safe (>2 months)</div>
    <div class="legend-item"><div class="legend-box" style="background: #854d0e;"></div> Critical (<2 months)</div>
    <div class="legend-item"><div class="legend-box" style="background: #7f1d1d;"></div> Stockout (0 units)</div>
    <div class="legend-item"><div class="legend-box" style="background: #1e40af;"></div> Container Arrives</div>
  </div>

  <div id="results"></div>

  <script>
    // Business constants
    const SALES_RATES = {
      King: 30, // units per month
      Queen: 41,
      Double: 6,
      'King Single': 3,
      Single: 1
    };

    const FIRMNESS_DISTRIBUTION = {
      King: { firm: 0.1356, medium: 0.8446, soft: 0.0198 },
      Queen: { firm: 0.1344, medium: 0.8269, soft: 0.0387 },
      Double: { firm: 0.2121, medium: 0.6061, soft: 0.1818 },
      'King Single': { firm: 0.1622, medium: 0.6216, soft: 0.2162 },
      Single: { firm: 0.2500, medium: 0.5833, soft: 0.1667 }
    };

    const SIZES = ['King', 'Queen', 'Double', 'King Single', 'Single'];
    const FIRMNESSES = ['firm', 'medium', 'soft'];

    // Test scenarios
    const scenarios = {
      A: {
        name: "Scenario A: Mid-Season Crisis",
        inventory: {
          firm: { King: 25, Queen: 30, Double: 18, 'King Single': 6, Single: 3 },
          medium: { King: 45, Queen: 60, Double: 28, 'King Single': 12, Single: 4 },
          soft: { King: 8, Queen: 12, Double: 8, 'King Single': 4, Single: 2 }
        },
        palletCount: 8,
        smallSizePallets: 1
      },
      B: {
        name: "Scenario B: Balanced Start",
        inventory: {
          firm: { King: 12, Queen: 16, Double: 4, 'King Single': 1, Single: 1 },
          medium: { King: 76, Queen: 102, Double: 11, 'King Single': 6, Single: 2 },
          soft: { King: 2, Queen: 5, Double: 3, 'King Single': 2, Single: 0 }
        },
        palletCount: 8,
        smallSizePallets: 1
      },
      C: {
        name: "Scenario C: Small Size Emergency (Double Medium = 0)",
        inventory: {
          firm: { King: 80, Queen: 110, Double: 8, 'King Single': 10, Single: 5 },
          medium: { King: 152, Queen: 203, Double: 0, 'King Single': 12, Single: 4 },
          soft: { King: 12, Queen: 24, Double: 7, 'King Single': 4, Single: 2 }
        },
        palletCount: 8,
        smallSizePallets: 1
      },
      D: {
        name: "Scenario D: Extreme Imbalance (King Firm = 0)",
        inventory: {
          firm: { King: 0, Queen: 22, Double: 8, 'King Single': 5, Single: 3 },
          medium: { King: 200, Queen: 203, Double: 22, 'King Single': 12, Single: 4 },
          soft: { King: 4, Queen: 10, Double: 7, 'King Single': 4, Single: 2 }
        },
        palletCount: 8,
        smallSizePallets: 1
      },
      E: {
        name: "Scenario E: N+2 Strategy (Two Small Sizes Critical)",
        inventory: {
          firm: { King: 80, Queen: 110, Double: 5, 'King Single': 10, Single: 1 },
          medium: { King: 152, Queen: 203, Double: 5, 'King Single': 12, Single: 0 },
          soft: { King: 12, Queen: 24, Double: 7, 'King Single': 4, Single: 2 }
        },
        palletCount: 8,
        smallSizePallets: 2
      },
      F: {
        name: "Scenario F: Everything Critical",
        inventory: {
          firm: { King: 8, Queen: 11, Double: 2, 'King Single': 1, Single: 0 },
          medium: { King: 38, Queen: 51, Double: 7, 'King Single': 3, Single: 1 },
          soft: { King: 1, Queen: 3, Double: 2, 'King Single': 1, Single: 0 }
        },
        palletCount: 8,
        smallSizePallets: 1
      }
    };

    function calculateCoverage(stock, size, firmness) {
      const monthlyDepletion = SALES_RATES[size] * FIRMNESS_DISTRIBUTION[size][firmness];
      return stock / monthlyDepletion;
    }

    function calculateOrder(scenario) {
      const { inventory, palletCount, smallSizePallets } = scenario;

      // Calculate coverage for small sizes (medium firmness only)
      const smallSizes = ['Double', 'King Single', 'Single'];
      const coverages = smallSizes.map(size => {
        const totalStock = inventory.firm[size] + inventory.medium[size] + inventory.soft[size];
        const totalCoverage = totalStock / SALES_RATES[size];
        const mediumCoverage = calculateCoverage(inventory.medium[size], size, 'medium');
        return { size, totalCoverage, mediumCoverage };
      });

      // Layer 1: Skip sizes with > 4 months coverage
      const CRITICAL_THRESHOLD = 4;
      const criticalSizes = coverages
        .filter(c => c.totalCoverage < CRITICAL_THRESHOLD)
        .sort((a, b) => a.mediumCoverage - b.mediumCoverage);

      const criticalCount = Math.min(criticalSizes.length, smallSizePallets);
      const smallSizeAllocation = criticalSizes.slice(0, criticalCount);

      const remainingPallets = palletCount - criticalCount;

      // King vs Queen coverage
      const kingCoverage = (inventory.firm.King + inventory.medium.King + inventory.soft.King) / SALES_RATES.King;
      const queenCoverage = (inventory.firm.Queen + inventory.medium.Queen + inventory.soft.Queen) / SALES_RATES.Queen;

      const queenPallets = queenCoverage <= kingCoverage
        ? Math.round(remainingPallets * 0.6)
        : Math.floor(remainingPallets * 0.4);
      const kingPallets = remainingPallets - queenPallets;

      // Allocate springs to each size
      const order = {};

      // Small sizes
      smallSizeAllocation.forEach(({ size }) => {
        order[size] = allocateSprings(size, 30, inventory);
      });

      // King
      if (kingPallets > 0) {
        order.King = allocateSprings('King', kingPallets * 30, inventory);
      }

      // Queen
      if (queenPallets > 0) {
        order.Queen = allocateSprings('Queen', queenPallets * 30, inventory);
      }

      return order;
    }

    function allocateSprings(size, totalSprings, inventory) {
      const TARGET_MONTHS = 8;
      const allocation = { firm: 0, medium: 0, soft: 0 };

      // Calculate needs
      const needs = {};
      let totalNeed = 0;

      FIRMNESSES.forEach(firmness => {
        const monthlyDepletion = SALES_RATES[size] * FIRMNESS_DISTRIBUTION[size][firmness];
        const target = TARGET_MONTHS * monthlyDepletion;
        const need = Math.max(0, target - inventory[firmness][size]);
        needs[firmness] = need;
        totalNeed += need;
      });

      // Allocate proportionally
      if (totalNeed > 0) {
        FIRMNESSES.forEach(firmness => {
          allocation[firmness] = Math.round((needs[firmness] / totalNeed) * totalSprings);
        });

        // Adjust for rounding errors
        const allocated = allocation.firm + allocation.medium + allocation.soft;
        if (allocated !== totalSprings) {
          const diff = totalSprings - allocated;
          const maxNeedFirmness = Object.keys(needs).reduce((a, b) => needs[a] > needs[b] ? a : b);
          allocation[maxNeedFirmness] += diff;
        }
      }

      return allocation;
    }

    function simulateMonths(scenario, months = 14) {
      const { inventory } = scenario;
      const order = calculateOrder(scenario);

      // Create inventory tracking
      const stock = {};
      SIZES.forEach(size => {
        stock[size] = {};
        FIRMNESSES.forEach(firmness => {
          stock[size][firmness] = inventory[firmness][size];
        });
      });

      // Track month by month
      const timeline = [];
      const stockouts = [];

      for (let month = 0; month <= months; month++) {
        const monthData = { month, stock: {}, stockouts: [] };

        // Add container at month 3 (10 weeks â‰ˆ 2.5 months, round to 3)
        if (month === 3) {
          SIZES.forEach(size => {
            if (order[size]) {
              FIRMNESSES.forEach(firmness => {
                stock[size][firmness] += order[size][firmness] || 0;
              });
            }
          });
          monthData.containerArrived = true;
        }

        // Record current stock
        SIZES.forEach(size => {
          monthData.stock[size] = {};
          FIRMNESSES.forEach(firmness => {
            monthData.stock[size][firmness] = stock[size][firmness];

            // Check for stockout
            if (stock[size][firmness] < 0) {
              stockouts.push({ month, size, firmness, deficit: -stock[size][firmness] });
              monthData.stockouts.push({ size, firmness });
            }
          });
        });

        timeline.push(monthData);

        // Deplete for next month
        if (month < months) {
          SIZES.forEach(size => {
            FIRMNESSES.forEach(firmness => {
              const monthlyDepletion = SALES_RATES[size] * FIRMNESS_DISTRIBUTION[size][firmness];
              stock[size][firmness] -= monthlyDepletion;
            });
          });
        }
      }

      return { timeline, stockouts, order };
    }

    function runSimulation(scenarioId) {
      const scenario = scenarios[scenarioId];
      const { timeline, stockouts, order } = simulateMonths(scenario);

      // Analyze results
      const firstStockout = stockouts.length > 0 ? stockouts[0] : null;
      const criticalMonth = timeline.findIndex(m => {
        return SIZES.some(size => {
          return FIRMNESSES.some(firmness => {
            const coverage = calculateCoverage(m.stock[size][firmness], size, firmness);
            return coverage < 2 && coverage > 0;
          });
        });
      });

      // Generate report
      const resultDiv = document.createElement('div');
      resultDiv.className = `scenario-result ${stockouts.length > 0 ? 'critical' : 'safe'}`;

      let html = `<div class="scenario-title">${scenario.name}</div>`;

      html += `<div class="summary">`;
      html += `<div class="summary-item">
        <div class="summary-label">Stockouts</div>
        <div class="summary-value ${stockouts.length > 0 ? 'critical' : 'healthy'}">
          ${stockouts.length > 0 ? stockouts.length : 'NONE âœ…'}
        </div>
      </div>`;

      if (firstStockout) {
        html += `<div class="summary-item">
          <div class="summary-label">First Stockout</div>
          <div class="summary-value critical">
            Month ${firstStockout.month}
          </div>
        </div>`;
        html += `<div class="summary-item">
          <div class="summary-label">Item</div>
          <div class="summary-value critical">
            ${firstStockout.size} ${firstStockout.firmness}
          </div>
        </div>`;
      } else {
        html += `<div class="summary-item">
          <div class="summary-label">Critical Warning</div>
          <div class="summary-value warning">
            ${criticalMonth >= 0 ? `Month ${criticalMonth}` : 'None'}
          </div>
        </div>`;
      }

      html += `<div class="summary-item">
        <div class="summary-label">Order Size</div>
        <div class="summary-value info">
          ${Object.values(order).reduce((sum, o) => sum + (o.firm || 0) + (o.medium || 0) + (o.soft || 0), 0)} springs
        </div>
      </div>`;
      html += `</div>`;

      // Timeline
      html += `<div class="timeline">`;
      for (let i = 0; i <= 14; i++) {
        const m = timeline[i];
        const hasStockout = m.stockouts.length > 0;
        const hasCritical = SIZES.some(size => {
          return FIRMNESSES.some(firmness => {
            const coverage = calculateCoverage(m.stock[size][firmness], size, firmness);
            return coverage < 2 && coverage > 0;
          });
        });

        let className = 'timeline-month';
        if (m.containerArrived) className += ' container';
        else if (hasStockout) className += ' stockout';
        else if (hasCritical) className += ' critical';

        html += `<div class="${className}">M${i}${m.containerArrived ? '<br>ðŸ“¦' : ''}</div>`;
      }
      html += `</div>`;

      // Stockout details
      if (stockouts.length > 0) {
        html += `<table class="stockout-table">`;
        html += `<thead><tr>
          <th>Month</th>
          <th>Size</th>
          <th>Firmness</th>
          <th>Deficit</th>
          <th>Impact</th>
        </tr></thead><tbody>`;

        stockouts.slice(0, 10).forEach(s => {
          const impact = (s.deficit / SALES_RATES[s.size]).toFixed(1);
          html += `<tr>
            <td class="stockout">Month ${s.month}</td>
            <td>${s.size}</td>
            <td>${s.firmness}</td>
            <td class="stockout">${s.deficit.toFixed(1)} units</td>
            <td class="stockout">${impact} months worth</td>
          </tr>`;
        });

        if (stockouts.length > 10) {
          html += `<tr><td colspan="5" style="text-align: center; color: #71717a;">... and ${stockouts.length - 10} more stockouts</td></tr>`;
        }

        html += `</tbody></table>`;
      } else {
        html += `<div style="padding: 20px; text-align: center; color: #22c55e; font-size: 16px; font-weight: bold;">
          âœ… NO STOCKOUTS - All sizes remain in stock for 14 months!
        </div>`;

        // Show minimum coverages
        html += `<div style="margin-top: 15px; font-size: 12px; color: #a1a1aa;">
          <strong>Minimum Coverage Reached:</strong><br>`;

        const minCoverages = [];
        SIZES.forEach(size => {
          FIRMNESSES.forEach(firmness => {
            let minCoverage = Infinity;
            let minMonth = 0;
            timeline.forEach(m => {
              const coverage = calculateCoverage(m.stock[size][firmness], size, firmness);
              if (coverage < minCoverage) {
                minCoverage = coverage;
                minMonth = m.month;
              }
            });
            minCoverages.push({ size, firmness, minCoverage, minMonth });
          });
        });

        minCoverages
          .filter(c => c.minCoverage < 3)
          .sort((a, b) => a.minCoverage - b.minCoverage)
          .slice(0, 5)
          .forEach(c => {
            const color = c.minCoverage < 1 ? 'warning' : c.minCoverage < 2 ? 'warning' : 'info';
            html += `<div style="margin: 5px 0;">
              <span class="${color}">${c.size} ${c.firmness}: ${c.minCoverage.toFixed(2)} months</span> (at Month ${c.minMonth})
            </div>`;
          });

        html += `</div>`;
      }

      resultDiv.innerHTML = html;
      document.getElementById('results').appendChild(resultDiv);
    }

    function runAllSimulations() {
      document.getElementById('results').innerHTML = '';
      Object.keys(scenarios).forEach(id => {
        runSimulation(id);
      });
    }
  </script>
</body>
</html>
